---
title: "PEC1_Datos_Omicos"
author: "Raul"
date: "2024-11-06"
output:
  pdf_document:
    toc: true
    toc_depth: '3'
  html_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r}
install.packages("tinytex")

```



```{r, eval=FALSE}

install.packages("readxl")
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("SummarizedExperiment")

```

<<<<<<< HEAD

# Abstract

Este estudio emplea un an√°lisis metabol√≥mico exhaustivo para identificar biomarcadores potenciales y explorar las alteraciones metab√≥licas espec√≠ficas en el c√°ncer g√°strico (GC) frente a tumores benignos (BN) y controles sanos (HE). Mediante resonancia magn√©tica nuclear (RMN), se analizaron metabolitos espec√≠ficos, siguiendo un control de calidad para garantizar la robustez de los datos. Aquellos metabolitos que mostraron un porcentaje de datos faltantes menor al 10% y una desviaci√≥n est√°ndar relativa (RSD) en los controles de calidad inferior al 20% fueron incluidos en el an√°lisis, asegurando as√≠ la precisi√≥n y consistencia de los resultados.

El an√°lisis estad√≠stico comenz√≥ con una exploraci√≥n de la variabilidad de los metabolitos entre los diferentes grupos. Se aplicaron pruebas de homogeneidad de varianza, como el test de Bartlett, que identific√≥ metabolitos con variabilidad significativamente distinta entre grupos (e.g., 1-Methylnicotinamide	(M4) con ùëù<4.2√ó10‚àí7 p<4.2√ó10‚àí7), sugiriendo alteraciones espec√≠ficas en el perfil metab√≥lico de los pacientes con GC. Estos resultados preliminares orientaron el enfoque hacia metabolitos espec√≠ficos que presentan un potencial discriminativo relevante en el contexto cl√≠nico.

En la evaluaci√≥n de diferencias de abundancia entre grupos, se calcul√≥ el fold change de cada metabolito, indicando aumentos significativos en ciertos metabolitos para el GC en comparaci√≥n con los controles sanos y benignos. Por ejemplo, el metabolito M4 mostr√≥ un incremento significativo en c√°ncer g√°strico respecto al control sano (HE) con un p-valor ajustado de 0.028, lo cual subraya su potencial como marcador diferencial.

Para comprender mejor las relaciones entre los metabolitos y su capacidad para distinguir entre los grupos cl√≠nicos, se realizaron an√°lisis multivariados, espec√≠ficamente An√°lisis de Componentes Principales (PCA) y An√°lisis Discriminante de M√≠nimos Cuadrados Parciales (PLS-DA). El PCA mostr√≥ una separaci√≥n clara entre los grupos HE, BN y GC, evidenciando que las muestras poseen patrones de expresi√≥n metab√≥lica diferenciados. En el modelo PLS-DA, que permite una separaci√≥n m√°s precisa entre clases, se identificaron metabolitos como M138, M134 y M118 como altamente discriminativos, lo que sugiere que estos compuestos pueden estar asociados con alteraciones metab√≥licas caracter√≠sticas del c√°ncer g√°strico. Los valores de clasificaci√≥n y validaci√≥n cruzada en PLS-DA indicaron una robustez razonable del modelo, con un error de clasificaci√≥n medio de 0.52 para el componente principal 1 (GC vs. HE) y de 0.41 en el segundo componente.

Los resultados obtenidos de este estudio resaltan la presencia de perfiles metab√≥licos alterados en pacientes con c√°ncer g√°strico, particularmente en metabolitos como M4, 2-Furoylglycine (M7) y u233 (M138), que presentan patrones de abundancia distintivos. Estos resultados aportan evidencia preliminar de posibles biomarcadores que podr√≠an contribuir a mejorar el diagn√≥stico y la comprensi√≥n de la fisiopatolog√≠a del c√°ncer g√°strico. No obstante, se requieren estudios adicionales para validar estos hallazgos en cohortes de mayor tama√±o y en otros contextos cl√≠nicos, lo cual permitir√≠a consolidar el papel de estos metabolitos como indicadores espec√≠ficos de GC.

Este an√°lisis metabol√≥mico proporciona una base significativa para futuros estudios que busquen integrar datos de m√∫ltiples √≥micas y enfoques bioinform√°ticos avanzados para el desarrollo de herramientas diagn√≥sticas y pron√≥sticas en c√°ncer g√°strico.



```{r}

# Cargar las librer√≠as
library(readxl)
library(SummarizedExperiment)

```

# *Objetivos del Estudio*

El objetivo principal de este trabajo es realizar un an√°lisis exploratorio de unos datos de metabolomica, descargados de un repositorio github, utilizando el programa estad√≠stico R y las librer√≠as para an√°lisis de datos √≥micos integradas en Bioconductor.

Como objetivos espec√≠ficos podemos se√±alar los siguientes:

1. Identificar un conjunto de datos (‚Äúdataset‚Äù) de inter√©s en la tabla proporcionada y descargarlo para crear, un objeto de clase SummarizedExperiment con los datos de expresi√≥n y sus meta-datos.

2. Llevar a cabo un an√°lisis exploratorio de los datos que proporcionar una visi√≥n general de las variables y de los individuos.

# *Materiales y M√©todos*

Es recomendable evaluar la calidad de los datos y eliminar cualquier metabolito que est√© mal medido antes de realizar an√°lisis estad√≠sticos o aplicar modelos de aprendizaje autom√°tico (Broadhurst et al., 2018). En el caso del conjunto de datos de C√°ncer G√°strico por RMN utilizado en este ejemplo, ya hemos calculado algunas estad√≠sticas b√°sicas para cada metabolito, las cuales se encuentran registradas en la tabla Peak. En este cuaderno, solo se mantendr√°n los metabolitos que cumplan con los siguientes requisitos:

Un QC-RSD inferior al 20%
Menos del 10% de los valores est√°n ausentes
Una vez que los datos sean depurados, se indicar√° la cantidad de picos que quedan.



# *Resultados*

## Estructura de los datos y del estudio


```{r}

# Leer las hojas del archivo Excel

file_path <- "GastricCancer_NMR.xlsx"
data_df <- read_excel(file_path, sheet = "Data")
metabolites_df <- read_excel(file_path, sheet = "Peak")

```



```{r}
# Filtrar las muestras para eliminar las que tienen SampleType = "QC"
data_df <- data_df[data_df$SampleType != "QC", ]

```

Extraemos del archivo las columnas que empiezan con M (Metabolito)

```{r}
# Extraer la matriz de datos de las columnas que empiezan con 'M'
metabolite_columns <- grep("^M", names(data_df), value = TRUE)
data_matrix <- as.matrix(data_df[, metabolite_columns])
```


Trasponemos la matriz de datos ya que el SummarizedExperiment necesita que las muestras sean columnas y los metabolitos (variables) filas

```{r}
# Transponer la matriz para que las muestras est√©n en las columnas
data_matrix <- t(data_matrix)

```

Ahora creamos los metadatos del SumarizedExperiment, en los metadatos de las muestras, est√° el grupo o Class = GC, gastic cancer, paciente sano, HE y BN, c√°mcer benigno. SAmpleID, el identificador de la muestra y SampleType, donde sample es una muestra humana y QC una muestra de control de calidad por lotes.

```{r}
# Crear los metadatos de las muestras (SampleID, SampleType, Class) despu√©s del filtrado
colData <- DataFrame(
    SampleID = data_df$SampleID,
    SampleType = data_df$SampleType,
    Class = data_df$Class
)
```

para los metadatos de las filas, de la hoja Peak, obtenemos la informaci√≥n. Name M1, M2..., Label con el nombre del metabolito en concreto, y dos datos m√°s para el control de calidad, el Perc_Missing, que es el porcentaje de datos faltantes, y el QC_RSD, que es la variabilidad entre muestras de ese metabolito.

```{r}
# Crear los metadatos de los metabolitos (Name, Label)
rowData <- DataFrame(
    Name = metabolites_df$Name,
    Label = metabolites_df$Label,
    Perc_missing = metabolites_df$Perc_missing,
    QC_RSD = metabolites_df$QC_RSD
)
```

Creamos el objeto se, calse SummarizedExperiment, con los datos trabajados hasta ahora.

```{r}
# Crear el objeto SummarizedExperiment
se <- SummarizedExperiment(
    assays = list(counts = data_matrix),
    rowData = rowData,
    colData = colData,
    metadata = list(
        description = "Columns M1 ... M149 describe metabolite concentrations. Column SampleType indicates whether the sample was a pooled QC or a study sample. Column Class indicates the clinical outcome observed for that individual: GC = Gastric Cancer, BN = Benign Tumor, HE = Healthy Control."
    )
)
```

Filtramos el dataset por los controles de calidad, donde solo aceptamos metabolitos con menos de un 20% de variabilidad entre datos, y menos de un 10% de datos faltantes.

```{r}
# Filtrar los metabolitos seg√∫n los criterios de calidad
se_filtered <- se[
  rowData(se)$Perc_missing < 10 & rowData(se)$QC_RSD < 20, 
  ]
```


```{r}
# Mostrar el objeto
print(se_filtered)
```


## 1. An√°lisis Descriptivo Inicial

```{r, echo=FALSE, eval=FALSE}
install.packages("ggplot2")
```


```{r}
# Cargar las librer√≠as necesarias
library(SummarizedExperiment)
library(ggplot2)
```



## 2. Visualizaci√≥n de Datos



## 3. An√°lisis de Variabilidad y Control de Calidad
1. An√°lisis de Varianza (ANOVA) o Test de Bartlett: Comparar la variabilidad de los metabolitos entre grupos (p. ej., control sano, tumor benigno, c√°ncer g√°strico) para evaluar diferencias significativas en la dispersi√≥n.

```{r}
# Extraer la matriz de datos y la informaci√≥n de los grupos
data_matrix <- assay(se_filtered, "counts")
class_labels <- colData(se_filtered)$Class

```

```{r}
# Aplicar el Test de Bartlett a cada metabolito
bartlett_results <- apply(data_matrix, 1, function(x) {
  bartlett.test(x ~ class_labels)$p.value
})

# Mostrar los resultados de los primeros 10 metabolitos
bartlett_results_df <- data.frame(
  Metabolite = rownames(data_matrix),
  P_Value = bartlett_results
)
print(bartlett_results_df)

```
Si un p-valor es menor que 0.05, sugiere que hay una diferencia significativa en la variabilidad de ese metabolito entre los grupos.

```{r}
# Aplicar ANOVA a cada metabolito
anova_results <- apply(data_matrix, 1, function(x) {
  summary(aov(x ~ class_labels))[[1]][["Pr(>F)"]][1]
})

# Mostrar los resultados de los primeros 10 metabolitos
anova_results_df <- data.frame(
  Metabolite = rownames(data_matrix),
  P_Value = anova_results
)
print(anova_results_df)

```

Un p-valor bajo (< 0.05) indica diferencias significativas en las medias de las concentraciones entre los grupos


2. PCA (An√°lisis de Componentes Principales):
* Realizar un PCA para visualizar la separaci√≥n global entre las clases (GC, BN, HE) y evaluar la presencia de agrupamientos claros o patrones.
* Este paso tambi√©n ayuda a identificar la necesidad de normalizaci√≥n adicional si hay un sesgo por efecto de lote o variabilidad t√©cnica.

El PCA se usa para reducir la dimensionalidad de los datos y visualizar c√≥mo se agrupan las muestras seg√∫n los metabolitos.

```{r}
# Funci√≥n para imputar valores faltantes con la mediana de cada fila (metabolito)
data_matrix <- assay(se_filtered, "counts")
data_matrix <- apply(data_matrix, 1, function(x) {
  x[is.na(x) | is.infinite(x)] <- median(x, na.rm = TRUE)
  return(x)
})
data_matrix <- t(data_matrix) 

```


```{r}
# Cargar la librer√≠a para el PCA
library(ggplot2)

# Transponer la matriz de datos para que las muestras sean filas y los metabolitos columnas
pca_data <- t(data_matrix)

# Realizar el PCA
pca_result <- prcomp(pca_data, scale. = TRUE)  # scale. = TRUE para normalizar los datos

# Crear un data frame con los resultados del PCA
pca_df <- data.frame(
  PC1 = pca_result$x[, 1],
  PC2 = pca_result$x[, 2],
  Class = class_labels
)

# Gr√°fico del PCA
ggplot(pca_df, aes(x = PC1, y = PC2, color = Class)) +
  geom_point(size = 3) +
  theme_minimal() +
  labs(
    title = "An√°lisis de Componentes Principales (PCA)",
    x = "Componente Principal 1",
    y = "Componente Principal 2"
  ) +
  scale_color_manual(values = c("red", "blue", "green"))

```
Como podemos ver los grupos se diferencian bien, as√≠ podemos afirmar que los grupos GC, BN, HE tiene diferentes patrones de expresion de los metabolitos, sobre todo se diferencia el grupo de interes GC.

## An√°lisis Univariado
Compararemos las concentraciones de cada metabolito entre las clases utilizando la prueba de t de Student o la prueba de Mann-Whitney U. Luego, aplicaremos una correcci√≥n por m√∫ltiples comparaciones

```{r, eval=FALSE}
install.packages("dplyr")

```

```{r}
library(dplyr)
```


```{r}
# Extraer los datos
data_matrix <- assay(se_filtered, "counts")
class_labels <- colData(se_filtered)$Class

# Inicializar un data frame para almacenar los resultados
results <- data.frame(Metabolite = rownames(data_matrix), p_GC_HE = NA, p_GC_BN = NA)

# Realizar las comparaciones entre grupos
for (i in 1:nrow(data_matrix)) {
  # Extraer concentraciones del metabolito actual
  metabolite_data <- data_matrix[i, ]
  
  # Comparaci√≥n entre GC y HE
  results$p_GC_HE[i] <- wilcox.test(metabolite_data[class_labels == "GC"], 
                                     metabolite_data[class_labels == "HE"])$p.value
  
  # Comparaci√≥n entre GC y BN
  results$p_GC_BN[i] <- wilcox.test(metabolite_data[class_labels == "GC"], 
                                     metabolite_data[class_labels == "BN"])$p.value
}

# Aplicar correcci√≥n por m√∫ltiples comparaciones (FDR de Benjamini-Hochberg)
results <- results %>%
  mutate(
    p_adj_GC_HE = p.adjust(p_GC_HE, method = "BH"),
    p_adj_GC_BN = p.adjust(p_GC_BN, method = "BH")
  )

# Mostrar los primeros resultados
print(results)

```
Los valores ajustados (p_adj_GC_HE y p_adj_GC_BN) reflejan la significancia despu√©s de la correcci√≥n por m√∫ltiples comparaciones. Un valor ajustado bajo (< 0.05) sugiere una diferencia significativa entre los grupos para ese metabolito.

## An√°lisis de Significancia Biol√≥gica: C√°lculo de Fold Change

```{r}
# Calcular fold change
results <- results %>%
  mutate(
    fold_change_GC_HE = apply(data_matrix, 1, function(x) {
      mean(x[class_labels == "GC"], na.rm = TRUE) / mean(x[class_labels == "HE"], na.rm = TRUE)
    }),
    fold_change_GC_BN = apply(data_matrix, 1, function(x) {
      mean(x[class_labels == "GC"], na.rm = TRUE) / mean(x[class_labels == "BN"], na.rm = TRUE)
    })
  )

# Mostrar los primeros resultados
print(results)

```
Un "fold change" mayor que 1 indica que el metabolito es m√°s abundante en el grupo GC en comparaci√≥n con HE o BN, mientras que un valor menor que 1 indica menor abundancia en GC.

## Analisis Multivariado

1. PLS-DA (Partial Least Squares Discriminant Analysis)

```{r}
# Instala mixOmics si no lo tienes
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("mixOmics")

library(mixOmics)

```

Configuramos los datos para PLS-DA
```{r}
# Extraer la matriz de datos y etiquetas de clase
data_matrix <- t(assay(se_filtered, "counts"))  # Transponer para que las muestras sean filas
class_labels <- colData(se_filtered)$Class

# Convertir las etiquetas de clase a un factor
class_labels <- as.factor(class_labels)

```

Ralizamos el PLS

```{r}
# Ejecutar PLS-DA
plsda_result <- plsda(X = data_matrix, Y = class_labels, ncomp = 2)  # ncomp = 2 componentes

# Graficar el PLS-DA
plotIndiv(plsda_result, group = class_labels, legend = TRUE, 
          title = "PLS-DA de Metabolitos", ellipse = TRUE, comp = c(1, 2))

```
plotIndiv muestra la discriminaci√≥n entre clases. El PLS-DA separa bien los grupos, lo que demuestra haber una clara diferencia entre grupos

Evaluar la Robustez del Modelo con Validaci√≥n Cruzad

```{r}
# Validaci√≥n cruzada con mixOmics
set.seed(625745221)  # Para reproducibilidad
cv_result <- perf(plsda_result, validation = "Mfold", folds = 5, progressBar = TRUE, nrepeat = 10)

# Ver resultados de validaci√≥n cruzada
print(cv_result)

```
error rate
```{r}
# Ver tasa de error
print(cv_result$error.rate)

```

Error rate por clase
```{r}
# Tasa de error por clase
print(cv_result$error.rate.class)

```

Validaci√≥n Cruzada: El resultado de la validaci√≥n cruzada (cv_result) ayuda a verificar si el modelo es robusto y no sobreajustado.

```{r}
# Graficar resultados de validaci√≥n cruzada
plot(cv_result)

```
Podemos ver c√≥mo var√≠a el error con el n√∫mero de componentes, lo cual es √∫til para decidir cu√°ntos componentes incluir en el modelo PLS-DA final. (Aunque aqu√≠ solo hemos ido con 2 componentes, podriamos incluir otro CP )

Analizar las Cargas (Loadings) para Identificar Metabolitos Relevantes

```{r}
# Extraer y visualizar las cargas para interpretar los metabolitos que m√°s contribuyen
loadings <- plsda_result$loadings$X  # Cargas para las variables

# Mostrar los primeros metabolitos relevantes
top_metabolites <- rownames(loadings)[order(abs(loadings[, 1]), decreasing = TRUE)[1:10]]
print(top_metabolites)

```

```{r}
# Crear un data frame con IDs y Labels de los metabolitos en rowData
metabolite_info <- data.frame(
  ID = rownames(rowData(se_filtered)),
  Label = rowData(se_filtered)$Label
)

# Filtrar para obtener solo los metabolitos en top_metabolites y asegurar el orden correcto
top_metabolite_info <- metabolite_info[match(top_metabolites, metabolite_info$ID), ]

# Mostrar los resultados correctamente alineados
print(top_metabolite_info)


```
Podemos ver cuales son los metabolitos que ser√≠an m√°s interesantes de estudiar como biomarcadores de este cancer

# *Discusi√≥n, Limitaciones y conclusiones del estudio*

Seg√∫n an√°lisis de la varianza, se revel√≥ diferencias significativas en la variabilidad de metabolitos espec√≠ficos entre grupos, evaluados a trav√©s del test de Bartlett. Por ejemplo, los metabolitos M4, M5, M7, y M8 presentaron p-valores muy bajos (e.g., M4 con ùëù<4.2√ó10‚àí7 p<4.2√ó10‚àí7), sugiriendo una variabilidad significativa en c√°ncer g√°strico.

Como se pudo observar en  el an√°lisis de Significancia Biol√≥gica y Fold Change, hubo un aumento en la concentraci√≥n de varios metabolitos en c√°ncer g√°strico en comparaci√≥n con controles sanos. El fold change de M4, por ejemplo, mostr√≥ un aumento significativo en GC respecto a HE, con valores ajustados de p = 0.028 para la comparaci√≥n GC-HE.

La proyecci√≥n de las muestras en un an√°lisis de componentes principales (PCA) indic√≥ una clara separaci√≥n entre los grupos. Adem√°s, el modelo PLS-DA evidenci√≥ una separaci√≥n robusta entre GC, BN y HE. Los metabolitos M138, M134 y M118 se destacaron como importantes en la discriminaci√≥n entre grupos.

La validaci√≥n cruzada del modelo PLS-DA mostr√≥ una tasa de error de clasificaci√≥n moderada. Para el componente principal 1, el error de clasificaci√≥n promedio fue de 0.52 para GC frente a HE y de 0.41 en el segundo componente. Este resultado sugiere que el modelo presenta una capacidad para discriminar razonable, para distinguir entre c√°ncer g√°strico y otros estados cl√≠nicos, aunque podr√≠a beneficiarse de otras optimizaciones adicionales.

As√≠ pues para finalizar, este estudio ha identificado metabolitos diferenciadores en c√°ncer g√°strico, proporcionando un marco preliminar para el desarrollo de biomarcadores diagn√≥sticos. Los hallazgos indican una alteraci√≥n en el perfil metab√≥lico de los pacientes con GC, especialmente en metabolitos como M4(1-Methylnicotinamide	), M7 (2-Furoylglycine) y M138 (metabolito u233), que podr√≠an ser interesantes para seguir trabajando en ellos en estudios adicionales.

Sin embargo, ser√≠a crucial validar estos resultados en cohortes m√°s amplias y en otros contextos cl√≠nicos para confirmar su aplicabilidad, como adem√°s, ser√≠a interesante a√±adir estudios con datos como el tiempo de supervivencia para realizar an√°lisis de Supervivencia y Pron√≥stico para ver si los perfiles metab√≥licos tienen alg√∫n valor pron√≥stico (p. ej., an√°lisis de Kaplan-Meier o modelos de Cox), y as√≠ identificar metabolitos espec√≠ficos que podr√≠an servir como biomarcadores para la detecci√≥n precoz del c√°ncer g√°strico o para predecir la respuesta al tratamiento.

# *Apendices*

Este estudio se encuentra en el repositorio github
https://github.com/GilCaraballo/PEC1_Datos_Omicos



